# 関数電卓（Scientific Calculator） on GitHub Pages

このリポジトリは **GitHub Pages 上で動く関数電卓アプリ**（静的フロントエンドのみ）を作成するプロジェクトです。  
**この README は AI エージェントが実装を進めるための仕様書・作業指示書**として機能します。

---

## 目標

- PC / スマホ両対応の関数電卓（科学計算）を **ブラウザだけ**で使えるようにする
- **安全に数式を評価**する（`eval()` などは使用しない）
- GitHub Pages にデプロイして公開する（PR/CIで自動化）
- テスト（少なくとも式評価のユニットテスト）を用意する

---

## スコープ

### ✅ 対象（必須）
- 基本演算：`+` `-` `×` `÷`（内部は `*` `/`）  
- 括弧：`(` `)`  
- べき乗：`^`
- 小数・符号：`.` / `+/-`
- 定数：`π`（pi）, `e`
- 代表的な関数：
  - `sin`, `cos`, `tan`
  - `asin`, `acos`, `atan`
  - `log`（常用対数）, `ln`（自然対数）
  - `sqrt`（平方根）, `abs`
  - `exp`（e^x）
  - `min(a,b,...)`, `max(a,b,...)`
- DEG/RAD 切替（三角関数の入力角度、逆三角関数の出力角度に反映）
- `AC`（全消去）, `⌫`（1文字削除）, `=`（評価）
- キーボード操作（最低限：数字、四則、Enter、Backspace、括弧）
- エラー表示（ゼロ除算、構文エラーなど）

### 🟨 できれば入れたい（任意）
- 履歴（直近の式と結果を一覧表示）
- `ANS`（直前の結果を参照する変数）
- メモリ機能（M+ / M- / MR / MC）
- PWA（オフライン対応）

### ❌ 対象外（今回はやらない）
- 複素数対応
- 記号計算（微分・積分・因数分解など）
- グラフ描画（別プロジェクト扱い）

---

## 技術方針（推奨）

- **Vite + TypeScript + Vanilla DOM**（React等の導入は不要）
- CSS は素の CSS（または CSS Modules）でよい
- テスト：**Vitest**（式評価エンジンはユニットテスト必須）
- Lint/Format：ESLint + Prettier（導入推奨）
- デプロイ：GitHub Actions で `dist/` を GitHub Pages に公開

> 依存ライブラリは最小限。  
> 数式評価は「自前実装（推奨）」か「安全なパーサライブラリ採用」のどちらでもよいが、**`eval()` 系は禁止**。

---

## 開発手順（ローカル）

- 依存関係のインストール: `npm install`
- 開発サーバ: `npm run dev`
- テスト: `npm test`
- ビルド: `npm run build`

---

## GitHub Pages

- `vite.config.ts` の `base` はリポジトリ名に合わせる（例: `/Sci-Calc/`）
- `main` ブランチへの push で `.github/workflows/deploy.yml` が実行される

---

## UI 要件

### 画面構成（最小）
- 上部：表示領域
  - 現在の入力式（小さめ）
  - 現在の値 / 結果（大きめ）
  - エラー時は「Error」＋簡潔な理由（可能なら）
- 中段（任意）：DEG/RAD トグル、ANS、メモリ
- 下部：ボタン群（グリッド）
  - 数字 0–9
  - `.` `+/-`
  - `+ - × ÷`
  - `(` `)` `^`
  - `sin cos tan log ln sqrt`
  - `AC` `⌫` `=`
  - `π` `e`

### 操作感
- ボタン連打でも崩れない
- スマホ幅でも押しやすい（最低 44px 程度のタップ領域）
- キーボード入力とボタン入力で同じ動作になる

### アクセシビリティ
- ボタンに `aria-label`
- フォーカスリングが見える
- キー操作：Tab 移動、Enter で押せる

---

## 数式評価（Expression Engine）仕様

### 許可するトークン
- 数値：`123`, `12.34`, `.5`, `5.`（最終的に正規化）
- 演算子：`+ - * / ^`
- 括弧：`(` `)`
- 引数区切り：`,`（min/max 等）
- 定数：`pi`, `e`（UI 表示は `π` でも内部は `pi`）
- 関数：`sin cos tan asin acos atan log ln sqrt abs exp min max`
- 変数（任意）：`ans`

### 優先順位（例）
1. 関数呼び出し `sin(x)`
2. べき乗 `^`（**右結合**：`2^3^2 = 2^(3^2)`）
3. 単項 `+` `-`（例：`-3`, `(-2)`)
4. 乗除 `* /`
5. 加減 `+ -`

### DEG/RAD
- `sin/cos/tan` の入力はモードで解釈
  - DEG: `sin(30)=0.5`
  - RAD: `sin(pi/6)=0.5`
- `asin/acos/atan` の出力もモードで変換
  - DEG: `asin(0.5)=30`
  - RAD: `asin(0.5)=pi/6`

### 数値の丸め・表示
- 内部は `number`（IEEE754）でOK
- 表示は以下を目安に整形：
  - 有効桁 12〜14 程度
  - 極端に大きい/小さい場合は指数表示
- `-0` は `0` として表示

### エラー処理
- 構文エラー：括弧不一致、未知のトークンなど
- 数学エラー：ゼロ除算、`sqrt(-1)`（複素数非対応）など
- エラー時は結果を更新せず、表示に `Error` を出す（履歴に入れてもよい）

---

## AI エージェント向け実装手順（必須）

### 1) 初期セットアップ
- [ ] Vite + TypeScript でプロジェクト作成
- [ ] `npm run dev` / `npm run build` が通る
- [ ] 基本のレイアウト（表示領域＋ボタン）を配置
- [ ] GitHub Pages デプロイ用の設定を入れる（後述）

### 2) Expression Engine を実装（最重要）
- [ ] `src/engine/` を作成し、UI から分離する  
- [ ] 入口関数：
  - `evaluate(expression: string, context: { mode: 'DEG'|'RAD', ans?: number }): { ok: true, value: number } | { ok: false, error: string }`
- [ ] `eval()` / `Function()` 禁止
- [ ] ユニットテスト（後述のテストケースを最低限含める）

> 実装方式（推奨）：  
> **Tokenizer → Shunting-yard（RPN化）→ RPN evaluator**  
> 関数/括弧/カンマを扱えるようにする。

### 3) UI と状態管理
- [ ] 状態：
  - `expression`（入力中の式）
  - `result`（表示値）
  - `mode`（DEG/RAD）
  - `ans`（直前結果）
  - `error`（表示用）
  - `history[]`（任意）
- [ ] クリック/キーボードで同じアクションを発火
- [ ] `=` で `evaluate()` を呼び出し、成功なら `ans` 更新

### 4) 仕上げ
- [ ] レスポンシブ調整（スマホで崩れない）
- [ ] アクセシビリティ（aria、フォーカス）
- [ ] デプロイ（Actions）を通す

---

## 受け入れ基準（Definition of Done）

最低限、以下が満たされていること：

- [ ] GitHub Pages で動作し、URL にアクセスすると電卓が使える
- [ ] `eval()` 不使用
- [ ] 主要機能が動く（四則、括弧、三角、log/ln、sqrt、π、e、DEG/RAD）
- [ ] ユニットテストがあり、CI で実行される
- [ ] キーボード入力に対応（数字、`+ - * /`、括弧、Enter、Backspace）
- [ ] エラー時に壊れない（画面が固まらない・変な値にならない）

---

## テストケース（最低限これを通す）

### 基本演算
- `1+2` => `3`
- `2*3+4` => `10`
- `2*(3+4)` => `14`
- `10/4` => `2.5`

### べき乗（右結合）
- `2^3^2` => `512`

### 定数
- `pi` => `3.141592...`
- `e` => `2.718281...`

### 関数
- `sqrt(9)` => `3`
- `ln(e)` => `1`
- `log(100)` => `2`
- `min(3,1,2)` => `1`
- `max(3,1,2)` => `3`

### 三角（DEG）
- mode=DEG: `sin(30)` => `0.5`
- mode=DEG: `asin(0.5)` => `30`

### 三角（RAD）
- mode=RAD: `sin(pi/6)` => `0.5`

### エラー
- `1/0` => Error
- `sqrt(-1)` => Error（複素数非対応）
- `((1+2)` => Error

---

## ディレクトリ構成（提案）

---

## 実装状況（2026-02-03）

- [x] Vite + TypeScript の初期構成
- [x] Expression Engine（Tokenizer → Shunting-yard → RPN）とユニットテスト
- [x] UI/状態管理/キーボード対応
- [x] GitHub Actions による Pages デプロイ設定
- [ ] 任意機能（履歴/メモリ/PWA など）
